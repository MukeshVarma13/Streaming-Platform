worker_processes auto;

events {
    worker_connections 4096;
}

rtmp {
    server {
        listen 1935;

        application live {
            live on;

            deny play all;

            # RECORDING
            record all;
            record_unique on;
            record_path /videos;
            record_suffix .flv;

            # HLS
            hls on;
            hls_path /videos/hls;
            hls_fragment 3;
            hls_playlist_length 20;
            hls_cleanup on;

            # DASH
            dash on;
            dash_path /videos/dash;
            dash_fragment 3;
            dash_playlist_length 20;

            # CALLBACK WHEN STREAM STARTS
            exec_publish curl -X POST http://backend:8080/api/stream/start \
                -d "name=$name";

            # CALLBACK WHEN STREAM STOPS
            exec_publish_done curl -X POST http://backend:8080/api/stream/complete \
                -d "name=$name";
        }
    }
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    server_tokens off;

    server {
        listen 80;
        server_name _;

        # HLS
        location /hls {
            alias /videos/hls;     # <-- FIXED
            add_header Cache-Control no-cache;
        }

        # DASH
        location /dash {
            alias /videos/dash;    # <-- FIXED
            add_header Cache-Control no-cache;
        }

        # Recorded FLV + converted MP4
        location /videos {
            alias /videos;
            autoindex on;
        }

        # Profile pictures
        location /profile-pics {
            alias /profile-pics;
        }
    }
}
